<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>JiBaJiBa v4.3 优化版</title>
<style>
:root {
    --bg-dark: #0f0f0f;
    --bg-card: #1b1b1b;
    --bg-hover: #2b2b2b;
    --text-main: #f1f1f1;
    --text-sub: #aaaaaa;
    --accent: #00a1d6;
}
* { box-sizing: border-box; }
body {
    margin:0; padding:15px;
    background: var(--bg-dark);
    color: var(--text-main);
    font-family: "Segoe UI", sans-serif;
}
.container { display:flex; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:10px; }
.title_ { display:flex; align-items:center; font-size:26px; font-weight:bold; }
.title_ img {
    height:38px; margin-right:10px; border-radius:8px;
    transition: transform 0.2s ease;
}
.title_ img:hover {
    transform: scale(1.2);
    cursor: pointer;
}
.protocols { display:flex; gap:6px; flex-wrap:wrap; }
.protocol-btn { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; background:var(--bg-card); color:var(--text-main); transition:0.2s; }
.protocol-btn.active { background:var(--accent); color:#fff; }
.protocol-btn:hover { background:var(--bg-hover); }

.search_ { display:flex; flex:1; min-width:200px; }
.text_enter { flex:1; background: var(--bg-card); border:1px solid var(--bg-hover); border-radius:6px; padding:8px; color:var(--text-main); }
.button_s { margin-left:10px; padding:8px 14px; border-radius:6px; border:none; background:var(--accent); color:#fff; cursor:pointer; transition:0.2s; }
.button_s:hover { background:#33b6e8; }

.main_ { display:flex; gap:18px; margin-top:18px; height:calc(100vh - 80px); flex-wrap:wrap; }
.videoContainer { flex:3; min-width:300px; background: var(--bg-card); border-radius:10px; padding:12px; box-shadow:0 0 12px rgba(0,0,0,0.35); display:flex; flex-direction:column; }
video { width:100%; flex:1; border-radius:10px; background:#000; }
.status { margin-top:6px; font-size:13px; color:var(--text-sub); }
.controls { margin-top:10px; display:flex; gap: 6px; flex-wrap:wrap; }
.button_l, .button_r { height: 30px; padding: 0 12px; border-radius:6px; border:none; cursor:pointer; font-size: 12px; transition:0.15s; }
.button_l { background:var(--bg-hover); color:var(--text-main); }
.button_r { background:var(--accent); color:white; }
.button_l:hover, .button_r:hover { background:#33b6e8; transform: translateY(-1px); box-shadow:0 2px 6px rgba(0,0,0,0.3); }

.buttons { flex:1; min-width:220px; display:flex; flex-direction:column; overflow-y:auto; max-height:100%; }
.section-title { font-size:14px; color:var(--text-main); margin:10px 0 4px 0; font-weight:bold; padding-left:6px; }

.button_play {
    display:flex; align-items:center; background:var(--bg-card); border:none; border-radius:10px; padding:10px; margin-bottom:6px;
    color:var(--text-main); cursor:pointer; transition: background 0.2s, transform 0.15s, box-shadow 0.15s;
    height:60px; width:100%; position:relative;
}
.button_play.manual { height:45px; }
.button_play:hover { background: var(--bg-hover); transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.4); }
.button_play:active { transform: translateY(0px); box-shadow:0 2px 6px rgba(0,0,0,0.3); }

.head_img { width:48px; height:48px; border-radius:50%; margin-right:10px; }

.url_text { font-size:11px; color:var(--text-sub); word-break: break-all; margin-left:58px; margin-top:-2px; }

.delete_btn { position:absolute; right:8px; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--text-main); font-weight:bold; cursor:pointer; font-size:inherit; transition: color 0.15s, transform 0.15s; }
.delete_btn:hover { color:#ff4d4d; transform: scale(1.2); }

.fullscreen-mode {
    position: fixed; top:0; left:0; width:100vw; height:100vh; background:black; z-index:9999;
    display:flex; flex-direction:column; justify-content:center; align-items:center;
}
.fullscreen-mode video { width:100%; height:100%; object-fit:contain; }
.fullscreen-controls {
    position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
    background: rgba(0,0,0,0.7); padding:10px; border-radius:5px; z-index:10000;
    opacity:1; transition: opacity 0.3s ease;
}
.fullscreen-controls.hidden { opacity:0; pointer-events:none; }
.fullscreen-controls button { margin:0 5px; color:white; background: var(--bg-hover); border:none; padding:8px 15px; border-radius:3px; cursor:pointer; transition:0.15s; }
.fullscreen-controls button:hover { background: var(--bg-card); }

@media(max-width:800px){ .main_ { flex-direction:column; } .videoContainer { height:300px; } }
</style>
</head>
<body>

<div class="container">
    <div class="title_"><img src="icon.png">JiBaJiBa</div>
    <div class="protocols">
        <button class="protocol-btn active" data-proto="whep">WHEP</button>
        <button class="protocol-btn" data-proto="whip">WHIP</button>
        <button class="protocol-btn" data-proto="rtmp">RTMP</button>
    </div>
    <div class="search_">
        <input id="roomInput" type="text" placeholder="输入房间号" class="text_enter">
        <button class="button_s" id="connectBtn">连接</button>
    </div>
</div>

<div class="main_">
    <div class="videoContainer">
        <video id="remoteVideo" autoplay playsinline muted controls></video>
        <div id="status" class="status">未连接</div>
        <div class="controls">
            <button class="button_l" id="refreshBtn">刷新</button>
            <button class="button_l" id="disconnectBtn">断开</button>
            <button class="button_l" id="fullscreenBtn">网页全屏</button>
        </div>
    </div>

    <div class="buttons" id="channelList">
        <div class="section-title">预设频道</div>
        <div id="presetContainer"></div>
        <div class="section-title">历史记录</div>
        <div id="historyContainer"></div>
    </div>
</div>

<script src="adapter.js"></script>
<script>
class JiBaJiBaPlayer {
    constructor() {
        this.pc=null;
        this.currentUrl=null;
        this.statsInterval=null;
        this.isFullscreen=false;
        this.fullscreenTimeout=null;
        this.currentProto='whep';
        this.video=document.getElementById('remoteVideo');
        this.statusEl=document.getElementById('status');
        this.fullscreenBtn=document.getElementById('fullscreenBtn');
        this.historyContainer=document.getElementById('historyContainer');
        this.presetContainer=document.getElementById('presetContainer');
        this.roomInput=document.getElementById('roomInput');

        this.presetChannels=[
            {name:'[直播] JOYG', img:'joyg.jpg', url:'http://10.126.126.10:1985/rtc/v1/whep/?app=live&stream=JOYG'},
            {name:'[直播] 超级老鼠', img:'cmhh.jpg', url:'http://10.126.126.10:1985/rtc/v1/whep/?app=live&stream=CMHH'},
            {name:'[直播] Pure1ove', img:'pl.jpg', url:'http://10.126.126.10:1985/rtc/v1/whep/?app=live&stream=PL'}
        ];

        this.bindUI();
        this.loadPresetChannels();
        this.updateStatus('就绪 - 点击频道或输入房间号开始播放');
    }

    bindUI(){
        document.querySelectorAll('.protocol-btn').forEach(btn=>{
            btn.addEventListener('click',()=>{
                document.querySelectorAll('.protocol-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                this.currentProto=btn.dataset.proto;
            });
        });

        document.getElementById('connectBtn').addEventListener('click', ()=>this.connectRoom());
        document.getElementById('refreshBtn').addEventListener('click', ()=>this.refresh());
        document.getElementById('disconnectBtn').addEventListener('click', ()=>this.disconnect());
        this.fullscreenBtn.addEventListener('click', ()=>this.toggleFullscreen());

        this.roomInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') this.connectRoom(); });

        document.addEventListener('keydown', (e)=>{
            if(e.key==='Escape' && this.isFullscreen) this.toggleFullscreen();
            if(e.key==='f' || e.key==='F'){ if(!this.isFullscreen && this.video.srcObject) this.toggleFullscreen(); }
        });
    }

    loadPresetChannels(){
        this.presetContainer.innerHTML='';
        this.presetChannels.forEach(ch=>{
            const btn=this.createChannelButton(ch.name,ch.img,ch.url,false);
            this.presetContainer.appendChild(btn);
        });
    }

    createChannelButton(name,img,url,manual=false){
        const btn=document.createElement('button');
        btn.className='button_play'+(manual?' manual':'');
        btn.onclick=()=>this.connectStream(url);

        if(img){
            const imgEl=document.createElement('img');
            imgEl.className='head_img';
            imgEl.src=img;
            btn.appendChild(imgEl);
        }

        const textNode=document.createTextNode(name);
        btn.appendChild(textNode);

        if(manual){
            const delBtn=document.createElement('button');
            delBtn.className='delete_btn';
            delBtn.innerText='×';
            delBtn.onclick=(e)=>{ e.stopPropagation(); btn.remove(); urlDiv.remove(); };
            btn.appendChild(delBtn);

            const urlDiv=document.createElement('div');
            urlDiv.className='url_text';
            urlDiv.innerText=url;
            this.historyContainer.appendChild(btn);
            this.historyContainer.appendChild(urlDiv);
        }
        return btn;
    }

    generateUrl(room){ if(!room) return null;
        switch(this.currentProto){
            case 'whep': return `http://10.126.126.10:1985/rtc/v1/whep/?app=live&stream=${room}`;
            case 'whip': return `http://10.126.126.10:1985/rtc/v1/whip/?app=live&stream=${room}`;
            case 'rtmp': return `rtmp://10.126.126.10/live/${room}`;
            default: return null;
        }
    }

    connectRoom(){
        const room=this.roomInput.value.trim();
        const url=this.generateUrl(room);
        if(!url) return;
        this.connectStream(url);
        this.addManualChannel(room,url);
    }

    addManualChannel(name,url){ this.createChannelButton(name,null,url,true); }

    refresh(){ if(this.currentUrl) this.connectStream(this.currentUrl); }

    disconnect(){
        if(this.pc){ this.pc.close(); this.pc=null; }
        if(this.statsInterval){ clearInterval(this.statsInterval); this.statsInterval=null; }
        this.video.srcObject=null;
        this.updateStatus('已断开连接');
        window._lastBytes=0;
        if(this.isFullscreen) this.toggleFullscreen();
    }

    async connectStream(url){
        this.disconnect();
        this.currentUrl=url;
        this.updateStatus('正在连接...');
        this.pc=new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
        this.pc.addTransceiver('video',{direction:'recvonly'});
        this.pc.addTransceiver('audio',{direction:'recvonly'});
        this.pc.ontrack=e=>{ this.video.srcObject=e.streams[0]; this.updateStatus('连接成功 · 正在接收视频'); };

        try{
            const offer=await this.pc.createOffer(); await this.pc.setLocalDescription(offer);
            const response=await fetch(url,{method:'POST', headers:{'Content-Type':'application/sdp'}, body:offer.sdp});
            if(!response.ok) throw new Error(`HTTP ${response.status}`);
            const answer=await response.text();
            await this.pc.setRemoteDescription({type:'answer', sdp:answer});
            this.startStats();
        }catch(e){ console.error(e); this.updateStatus(`连接失败: ${e.message}`); this.disconnect(); }
    }

    startStats(){
        if(this.statsInterval) clearInterval(this.statsInterval);
        this.statsInterval=setInterval(async()=>{
            if(!this.pc||this.pc.connectionState!=='connected') return;
            try{
                const stats=await this.pc.getStats();
                let fps=0, bitrate=0, rtt=0, loss=0;
                stats.forEach(r=>{
                    if(r.type==='inbound-rtp' && r.kind==='video'){
                        if(r.framesPerSecond) fps=r.framesPerSecond;
                        if(r.bytesReceived&&r.timestamp){
                            if(!window._lastBytes) window._lastBytes=r.bytesReceived;
                            const dt=(r.timestamp-(window._lastTimestamp||r.timestamp))/1000;
                            if(dt>0) bitrate=((r.bytesReceived-window._lastBytes)*8/dt/1024/1024).toFixed(2);
                            window._lastBytes=r.bytesReceived; window._lastTimestamp=r.timestamp;
                        }
                        if(r.packetsLost!==undefined && r.packetsReceived){ const total=r.packetsLost+r.packetsReceived; loss=total>0?(r.packetsLost/total*100).toFixed(2):0; }
                    }
                    if(r.type==='candidate-pair' && r.currentRoundTripTime) rtt=(r.currentRoundTripTime*1000).toFixed(0);
                });
                this.updateStatus(`延迟: ${rtt}ms | 码率: ${bitrate}Mbps | FPS: ${fps} | 丢包率: ${loss}%`);
            }catch(e){ console.error('获取统计失败:',e); }
        },1000);
    }

    toggleFullscreen(){
        if(!this.isFullscreen){
            const fullscreenDiv=document.createElement('div');
            fullscreenDiv.className='fullscreen-mode'; fullscreenDiv.id='fullscreenContainer';
            const controlsDiv=document.createElement('div'); controlsDiv.className='fullscreen-controls';
            controlsDiv.innerHTML = `<button onclick="player.disconnect()">断开</button><button onclick="player.toggleFullscreen()">退出全屏</button>`;
            const videoClone=this.video.cloneNode(true); videoClone.controls=true;
            if(this.video.srcObject) videoClone.srcObject=this.video.srcObject;
            fullscreenDiv.appendChild(videoClone); fullscreenDiv.appendChild(controlsDiv);
            document.body.appendChild(fullscreenDiv);
            this.video.style.display='none'; this.fullscreenBtn.textContent='退出全屏'; this.isFullscreen=true;
            this.fullscreenTimeout=setTimeout(()=>controlsDiv.classList.add('hidden'),1000);
            fullscreenDiv.addEventListener('mousemove', ()=>{
                controlsDiv.classList.remove('hidden'); clearTimeout(this.fullscreenTimeout);
                this.fullscreenTimeout=setTimeout(()=>controlsDiv.classList.add('hidden'),1000);
            });
            controlsDiv.addEventListener('mouseleave', ()=>{ this.fullscreenTimeout=setTimeout(()=>controlsDiv.classList.add('hidden'),1000); });
        }else{
            const fullscreenContainer=document.getElementById('fullscreenContainer');
            if(fullscreenContainer) document.body.removeChild(fullscreenContainer);
            if(this.fullscreenTimeout) clearTimeout(this.fullscreenTimeout);
            this.video.style.display='block'; this.fullscreenBtn.textContent='网页全屏'; this.isFullscreen=false;
        }
    }

    updateStatus(text){ this.statusEl.innerText=text; }
}

const player = new JiBaJiBaPlayer();
</script>

</body>
</html>
