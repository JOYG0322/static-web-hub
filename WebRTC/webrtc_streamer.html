<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>内网屏幕共享</title>

<style>
:root {
    --bg-dark: #1a1a1a;
    --bg-card: #2c2c2c;
    --bg-hover: #3e3e3e;
    --text-main: #e0e0e0;
    --text-sub: #cccccc;
    --accent: #00a1d6;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    background: var(--bg-dark);
    color: var(--text-main);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
}

.container {
    max-width: 420px;
    margin: 40px auto;
    padding: 20px;
}

.card {
    background: var(--bg-card);
    border-radius: 10px;
    padding: 20px;
}

h1 {
    margin: 0 0 16px;
    font-size: 20px;
    text-align: center;
}

label {
    display: block;
    font-size: 13px;
    color: var(--text-sub);
    margin-top: 14px;
}

input {
    width: 100%;
    margin-top: 6px;
    padding: 10px;
    border-radius: 6px;
    border: none;
    background: #111;
    color: var(--text-main);
}

button {
    width: 100%;
    margin-top: 20px;
    padding: 12px;
    border: none;
    border-radius: 6px;
    background: var(--accent);
    color: #fff;
    font-size: 15px;
    cursor: pointer;
}

button:hover {
    opacity: 0.9;
}

.status {
    margin-top: 14px;
    font-size: 13px;
    color: var(--text-sub);
    text-align: center;
}
</style>
</head>

<body>
<div class="container">
    <div class="card">
        <h1>屏幕共享</h1>

        <label>MediaMTX 地址</label>
        <input id="host" placeholder="例如：10.0.0.10" value="127.0.0.1" />

        <label>用户名</label>
        <input id="user" placeholder="zhangsan / lisi / roomA" />

        <button id="startBtn">开始共享</button>

        <div class="status" id="status">未连接</div>
    </div>
</div>

<script>
const startBtn = document.getElementById('startBtn');
const statusEl = document.getElementById('status');

startBtn.onclick = async () => {
    const host = document.getElementById('host').value.trim();
    const user = document.getElementById('user').value.trim() || 'anonymous';

    try {
        statusEl.textContent = '请求屏幕权限…';

        const stream = await navigator.mediaDevices.getDisplayMedia({
            video: {
                frameRate: { ideal: 15, max: 30 },
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: false
        });

        const pc = new RTCPeerConnection();

        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        pc.onconnectionstatechange = () => {
            statusEl.textContent = '连接状态：' + pc.connectionState;
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        statusEl.textContent = '连接 MediaMTX…';

        const res = await fetch(`http://${host}:8889/screen/whip`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/sdp'
            },
            body: offer.sdp
        });

        if (!res.ok) {
            throw new Error(`MediaMTX 返回 ${res.status}`);
        }

        const answerSDP = await res.text();

        await pc.setRemoteDescription({
            type: 'answer',
            sdp: answerSDP
        });


        statusEl.textContent = `正在共享（用户：${user}）`;

    } catch (err) {
        console.error(err);
        statusEl.textContent = '错误：' + err.message;
    }
};
</script>
</body>
</html>
